version: "3.8"

services:
  # VPN container - routes traffic through ProtonVPN
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      # Backend port exposed through VPN
      - "3001:3001"
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - OPENVPN_USER=6PbK1i90BTwe1b0e
      - OPENVPN_PASSWORD=Er8kjlJqvbSIc1fvv8MKdqTdUUBajnzw
      # Singapore - Binance/Bybit friendly region
      - SERVER_COUNTRIES=Singapore
      - VPN_TYPE=openvpn
      - TZ=UTC
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "https://api.ipify.org" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend server - runs through VPN
  traderbias-backend:
    build: .
    container_name: traderbias-backend
    network_mode: "service:gluetun"
    depends_on:
      - gluetun
    environment:
      - NODE_ENV=production
      - PORT=3001
      - CORS_ORIGIN=*
    restart: unless-stopped
